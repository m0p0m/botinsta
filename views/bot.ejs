<div class="dashboard-main">
  <% if (typeof error !== 'undefined' && error) { %>
    <div class="alert alert-error">
      <span class="alert-icon">âš ï¸</span>
      <div class="alert-content"><%= error %></div>
    </div>
  <% } %>

  <!-- Header -->
  <div class="dashboard-header">
    <div class="header-content">
      <h1>ğŸ¤– Ú©Ù†ØªØ±Ù„ Ø±Ø¨Ø§Øª Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…</h1>
      <p class="header-subtitle">Ø´Ø±ÙˆØ¹ Ùˆ ØªÙˆÙ‚Ù Ø±Ø¨Ø§Øª</p>
    </div>
    <% if (selectedAccount) { %>
      <div class="account-badge">
        <span class="badge-icon">âœ“</span>
        <span class="badge-text"><%= selectedAccount %></span>
      </div>
    <% } %>
  </div>

  <% if (accounts && accounts.length) { %>
    <!-- Bot Controls -->
    <section class="section section-full">
      <div class="section-header"><h2>âš™ï¸ Ú©Ù†ØªØ±Ù„ Ø±Ø¨Ø§Øª</h2></div>
      <div class="bot-panel">
        <form id="start-form" action="/start" method="POST">
          <input type="hidden" name="username" value="<%= selectedAccount %>">
          <div class="form-row">
            <div class="form-group">
              <label>Ù†ÙˆØ¹ Ø¹Ù…Ù„ÛŒØ§Øª</label>
              <select name="type" id="bot-type" required>
                <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                <option value="hashtag">ğŸ·ï¸ Ù‡Ø´ØªÚ¯</option>
                <option value="explore">ğŸ” Ø§Ú©Ø³Ù¾Ù„ÙˆØ±</option>
              </select>
            </div>
            <div class="form-group">
              <label>Ù‡Ø¯Ù (Ù‡Ø´ØªÚ¯)</label>
              <select id="target-select" name="target" required>
                <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                <% if (hashtags && hashtags.length) { %>
                  <% hashtags.forEach(function(h){ %>
                    <option value="<%= h %>">#<%= h %></option>
                  <% }) %>
                <% } %>
              </select>
            </div>
            <div class="form-group">
              <label>Ù†ÙˆØ¹ Ù¾Ø³Øªâ€ŒÙ‡Ø§</label>
              <select name="sortType" id="sort-type" required>
                <option value="recent">ğŸ†• Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†</option>
                <option value="top">â­ Ø¨Ø±ØªØ±ÛŒÙ†</option>
              </select>
            </div>
            <div class="form-group">
              <label>Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
              <input type="time" name="startTime">
            </div>
          </div>
          <button type="submit" id="start-btn" class="btn-start">â–¶ï¸ Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª</button>
        </form>

        <form id="stop-form" action="/stop" method="POST" style="display:none;">
          <input type="hidden" name="username" value="<%= selectedAccount %>">
          <button type="submit" id="stop-btn" class="btn-stop">â¹ï¸ ØªÙˆÙ‚Ù Ø±Ø¨Ø§Øª</button>
        </form>
        
        <div id="bot-starting-indicator" class="bot-starting-indicator" style="display: none;">
          <div class="indicator-content">
            <div class="spinner"></div>
            <span>Ø¯Ø± Ø­Ø§Ù„ Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª...</span>
          </div>
        </div>
      </div>

      <!-- Status Area -->
      <div class="status-area">
        <div class="status-header">
          <h3>ğŸ“Š ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ</h3>
          <span class="status-light inactive" id="status-light"></span>
        </div>
        <div class="status-info">
          <div class="status-row">
            <span class="label">ÙˆØ¶Ø¹ÛŒØª Ø±Ø¨Ø§Øª:</span>
            <span class="value" id="bot-status">ğŸ”´ ØºÛŒØ±ÙØ¹Ø§Ù„</span>
          </div>
          <div class="status-row">
            <span class="label">ØªØ¹Ø¯Ø§Ø¯ Ù„Ø§ÛŒÚ©:</span>
            <span class="value" id="bot-likes">0</span>
          </div>
          <div class="status-row">
            <span class="label">ÙØ¹Ø§Ù„ÛŒØª:</span>
            <span class="value" id="bot-activity">Ø¨Ø¯ÙˆÙ† ÙØ¹Ø§Ù„ÛŒØª</span>
          </div>
          <div class="status-row" id="current-target-row" style="display: none;">
            <span class="label">Ù‡Ø´ØªÚ¯ ÙØ¹Ù„ÛŒ:</span>
            <span class="value" id="current-target">-</span>
          </div>
        </div>
      </div>

      <!-- Activity Log -->
      <div class="activity-area">
        <div class="activity-header">
          <h3>ğŸ“ Ú¯Ø²Ø§Ø±Ø´ ÙØ¹Ø§Ù„ÛŒØª</h3>
          <button id="clear-log-btn" class="btn-clear-log" title="Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯">ğŸ—‘ï¸</button>
        </div>
        <div class="activity-log" id="activity-log">
          <div class="log-entry log-info">
            <span class="log-time">-</span>
            <span class="log-msg">Ù…Ù†ØªØ¸Ø± Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª...</span>
          </div>
        </div>
      </div>
    </section>
  <% } else { %>
    <!-- Empty State -->
    <div class="empty-state">
      <div class="empty-icon">ğŸš€</div>
      <h2>Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯ÛŒØ¯!</h2>
      <p>Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø§Ú©Ø§Ù†Øª Instagram Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯</p>
      <a href="/" class="btn-primary btn-large">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a>
    </div>
  <% } %>
</div>

<script>
(function() {
  // Bot state management
  let botIsRunning = false;

  // Start form handler
  const startForm = document.getElementById('start-form');
  const botTypeSelect = document.getElementById('bot-type');
  const targetSelect = document.getElementById('target-select');
  
  // Show/hide target select based on bot type
  if (botTypeSelect && targetSelect) {
    botTypeSelect.addEventListener('change', () => {
      if (botTypeSelect.value === 'hashtag') {
        targetSelect.closest('.form-group').style.display = 'flex';
        targetSelect.required = true;
      } else {
        targetSelect.closest('.form-group').style.display = 'none';
        targetSelect.required = false;
      }
    });
    
    // Initial state
    if (botTypeSelect.value !== 'hashtag') {
      targetSelect.closest('.form-group').style.display = 'none';
      targetSelect.required = false;
    }
  }
  
  if (startForm) {
    startForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const startBtn = document.getElementById('start-btn');
      const botType = document.getElementById('bot-type').value;
      const target = document.getElementById('target-select').value;
      const sortType = document.getElementById('sort-type').value;
      const startTime = document.querySelector('input[name="startTime"]').value;
      const usernameInput = document.querySelector('input[name="username"]');
      let username = usernameInput ? usernameInput.value : null;
      
      if (!username || username.trim() === '') {
        const hiddenUsername = document.querySelector('#start-form input[name="username"]');
        username = hiddenUsername ? hiddenUsername.value : null;
      }
      
      if (botType === 'hashtag' && !target) {
        showNotification('âŒ Ù„Ø·ÙØ§ ÛŒÚ© Ù‡Ø´ØªÚ¯ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
        return;
      }
      
      if (!botType) {
        showNotification('âŒ Ù„Ø·ÙØ§ Ù†ÙˆØ¹ Ø¹Ù…Ù„ÛŒØ§Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
        return;
      }
      
      if (!username || username.trim() === '') {
        showNotification('âŒ Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø§Ú©Ø§Ù†Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
        return;
      }
      
      startBtn.disabled = true;
      startBtn.textContent = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø´Ø±ÙˆØ¹...';
      
      const indicator = document.getElementById('bot-starting-indicator');
      if (indicator) indicator.style.display = 'block';
      
      try {
        const formData = new FormData();
        formData.append('username', username);
        formData.append('type', botType);
        formData.append('target', target);
        formData.append('sortType', sortType);
        if (startTime) formData.append('startTime', startTime);
        
        const response = await fetch('/start', {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: formData
        });
        
        let data;
        try {
          data = await response.json();
        } catch (jsonError) {
          throw new Error('Ù¾Ø§Ø³Ø® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø² Ø³Ø±ÙˆØ±');
        }
        
        if (response.ok && data.success) {
          showNotification('âœ… ' + data.message);
        } else {
          const errorMsg = data.error || data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª';
          showNotification('âŒ ' + errorMsg);
          startBtn.disabled = false;
          startBtn.textContent = 'â–¶ï¸ Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª';
          if (indicator) indicator.style.display = 'none';
        }
      } catch (error) {
        console.error('Error starting bot:', error);
        showNotification('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±: ' + (error.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ'));
        startBtn.disabled = false;
        startBtn.textContent = 'â–¶ï¸ Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª';
        if (indicator) indicator.style.display = 'none';
      }
    });
  }
  
  // Stop form handler
  const stopForm = document.getElementById('stop-form');
  if (stopForm) {
    stopForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const stopBtn = document.getElementById('stop-btn');
      const username = document.querySelector('#stop-form input[name="username"]').value;
      
      stopBtn.disabled = true;
      stopBtn.textContent = 'â³ Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ‚Ù...';
      
      try {
        const formData = new FormData();
        formData.append('username', username);
        
        const response = await fetch('/stop', {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: formData
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          showNotification('âœ… ' + data.message);
        } else {
          showNotification('âŒ ' + (data.error || 'Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ‚Ù Ø±Ø¨Ø§Øª'));
          stopBtn.disabled = false;
          stopBtn.textContent = 'â¹ï¸ ØªÙˆÙ‚Ù Ø±Ø¨Ø§Øª';
        }
      } catch (error) {
        console.error('Error stopping bot:', error);
        showNotification('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
        stopBtn.disabled = false;
        stopBtn.textContent = 'â¹ï¸ ØªÙˆÙ‚Ù Ø±Ø¨Ø§Øª';
      }
    });
  }

  // WebSocket for bot status
  function initWebSocket() {
    try {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const ws = new WebSocket(protocol + '//' + window.location.host);

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        
        if (data.status) {
          const statusEl = document.getElementById('bot-status');
          const statusLight = document.getElementById('status-light');
          const startBtn = document.getElementById('start-btn');
          const stopBtn = document.getElementById('stop-btn');
          const stopForm = document.getElementById('stop-form');
          const startForm = document.getElementById('start-form');

          if (data.status === 'running') {
            botIsRunning = true;
            const indicator = document.getElementById('bot-starting-indicator');
            if (indicator) indicator.style.display = 'none';
            
            if (statusEl) {
              statusEl.textContent = 'ğŸŸ¢ ÙØ¹Ø§Ù„ Ùˆ Ø¯Ø± Ø­Ø§Ù„ Ú©Ø§Ø±';
              statusEl.style.color = '#31c48d';
              statusEl.classList.add('running');
            }
            if (statusLight) {
              statusLight.classList.remove('inactive');
              statusLight.classList.add('running');
              statusLight.style.background = '#31c48d';
            }
            if (startForm) startForm.style.display = 'none';
            if (stopForm) stopForm.style.display = 'block';
          } else {
            botIsRunning = false;
            if (statusEl) {
              statusEl.textContent = 'ğŸ”´ ØºÛŒØ±ÙØ¹Ø§Ù„';
              statusEl.style.color = '#ff3b30';
            }
            if (statusLight) {
              statusLight.classList.add('inactive');
              statusLight.style.background = '#ccc';
            }
            if (startForm) startForm.style.display = 'block';
            if (stopForm) stopForm.style.display = 'none';
          }
        }

        if (data.target) {
          const targetRow = document.getElementById('current-target-row');
          const targetEl = document.getElementById('current-target');
          if (targetRow) targetRow.style.display = 'flex';
          if (targetEl) targetEl.textContent = `#${data.target}`;
        }

        if (data.message) {
          const activity = document.getElementById('bot-activity');
          if (activity) activity.textContent = data.message;

          if (typeof data.likes !== 'undefined') {
            const likesEl = document.getElementById('bot-likes');
            if (likesEl) likesEl.textContent = data.likes;
          }

          const log = document.getElementById('activity-log');
          if (log) {
            const entry = document.createElement('div');
            let logClass = 'log-entry';
            if (data.status === 'running') logClass += ' log-success';
            else if (data.status === 'error') logClass += ' log-error';
            else if (data.status === 'liked' || data.status === 'post_completed') logClass += ' log-success';
            else if (data.status === 'processing' || data.status === 'liking') logClass += ' log-info';
            else logClass += ' log-info';
            
            entry.className = logClass;
            const time = new Date().toLocaleTimeString('fa-IR', {
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit'
            });

            let msgHtml = '';
            const safeMsg = (data.message || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            if (data.postLink) {
              msgHtml = `${safeMsg} <a href="${data.postLink}" target="_blank" rel="noopener noreferrer" class="post-link">ğŸ”— Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø³Øª</a>`;
            } else {
              msgHtml = safeMsg;
            }

            entry.innerHTML = `<span class="log-time">${time}</span><span class="log-msg">${msgHtml}</span>`;
            log.insertBefore(entry, log.firstChild);

            while (log.children.length > 100) {
              log.removeChild(log.lastChild);
            }
            
            log.scrollTop = 0;
          }
        }
      };

      ws.onerror = (error) => console.error('WebSocket error:', error);
      ws.onclose = () => setTimeout(initWebSocket, 3000);
    } catch (e) {
      console.error('WebSocket error:', e);
    }
  }

  function showNotification(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      bottom: 2rem;
      right: 1rem;
      background: white;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 999;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
      notification.remove();
    }, 3000);
  }

  // Clear log button
  const clearLogBtn = document.getElementById('clear-log-btn');
  if (clearLogBtn) {
    clearLogBtn.addEventListener('click', () => {
      const log = document.getElementById('activity-log');
      if (log && confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ØªÙ…Ø§Ù… Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯ØŸ')) {
        log.innerHTML = '<div class="log-entry log-info"><span class="log-time">-</span><span class="log-msg">Ù„Ø§Ú¯ Ù¾Ø§Ú© Ø´Ø¯. Ù…Ù†ØªØ¸Ø± ÙØ¹Ø§Ù„ÛŒØª Ø¬Ø¯ÛŒØ¯...</span></div>';
      }
    });
  }

  if (document.querySelector('.status-area')) {
    initWebSocket();
  }
})();
</script>
