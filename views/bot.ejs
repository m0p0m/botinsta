<%- include('partials/header') %>

<div class="dashboard-main">
  <!-- Header -->
  <div class="dashboard-header">
    <div class="header-content">
      <h1>โ๏ธ ฺฉูุชุฑู ุฑุจุงุช</h1>
      <p class="header-subtitle">ุฑุจุงุช ุงูุณุชุงฺฏุฑุงู ุฑุง ูุนุงู ุง ุบุฑูุนุงู ฺฉูุฏ</p>
    </div>
  </div>

  <% if (typeof error !== 'undefined' && error) { %>
    <div class="alert alert-error">
      <span class="alert-icon">โ๏ธ</span>
      <div class="alert-content"><%= error %></div>
    </div>
  <% } %>

  <!-- Bot Controls -->
  <section class="section section-full">
    <div class="section-header"><h2>ุชูุธูุงุช ุฑุจุงุช</h2></div>
    <div class="bot-panel">
      <form id="start-form" action="/start" method="POST">
        <input type="hidden" name="username" value="<%= selectedAccount %>">
        <div class="form-row">
          <div class="form-group">
            <label>ููุน ุนููุงุช</label>
            <select name="type" id="bot-type" required>
              <option value="">ุงูุชุฎุงุจ ฺฉูุฏ...</option>
              <option value="hashtag">๐ท๏ธ ูุดุชฺฏ</option>
              <option value="explore">๐ ุงฺฉุณูพููุฑ</option>
            </select>
          </div>
          <div class="form-group">
            <label>ูุฏู (ูุดุชฺฏ)</label>
            <select id="target-select" name="target" required>
              <option value="">ุงูุชุฎุงุจ ฺฉูุฏ...</option>
              <% if (hashtags && hashtags.length) { %>
                <% hashtags.forEach(function(h){ %>
                  <option value="<%= h %>">#<%= h %></option>
                <% }) %>
              <% } %>
            </select>
          </div>
          <div class="form-group">
            <label>ููุน ูพุณุชโูุง</label>
            <select name="sortType" id="sort-type" required>
              <option value="recent">๐ ุฌุฏุฏุชุฑู</option>
              <option value="top">โญ ุจุฑุชุฑู</option>
            </select>
          </div>
          <div class="form-group">
            <label>ุฒูุงู ุดุฑูุน (ุงุฎุชุงุฑ)</label>
            <input type="time" name="startTime">
          </div>
        </div>
        <button type="submit" id="start-btn" class="btn-start">โถ๏ธ ุดุฑูุน ุฑุจุงุช</button>
      </form>

      <form id="stop-form" action="/stop" method="POST" style="display:none;">
        <input type="hidden" name="username" value="<%= selectedAccount %>">
        <button type="submit" id="stop-btn" class="btn-stop">โน๏ธ ุชููู ุฑุจุงุช</button>
      </form>
    </div>
  </section>
</div>

<script>
(function() {
  // Bot state management
  let botIsRunning = false;

  // Start form handler
  const startForm = document.getElementById('start-form');
  const botTypeSelect = document.getElementById('bot-type');
  const targetSelect = document.getElementById('target-select');
  
  // Show/hide target select based on bot type
  if (botTypeSelect && targetSelect) {
    botTypeSelect.addEventListener('change', () => {
      if (botTypeSelect.value === 'hashtag') {
        targetSelect.closest('.form-group').style.display = 'flex';
        targetSelect.required = true;
      } else {
        targetSelect.closest('.form-group').style.display = 'none';
        targetSelect.required = false;
      }
    });
    
    // Initial state
    if (botTypeSelect.value !== 'hashtag') {
      targetSelect.closest('.form-group').style.display = 'none';
      targetSelect.required = false;
    }
  }
  
  if (startForm) {
    startForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const startBtn = document.getElementById('start-btn');
      const botType = document.getElementById('bot-type').value;
      const target = document.getElementById('target-select').value;
      const sortType = document.getElementById('sort-type').value;
      const startTime = document.querySelector('input[name="startTime"]').value;
      const username = document.querySelector('input[name="username"]').value;
      
      if (!username) {
        showNotification('โ ูุทูุง ุงุจุชุฏุง ฺฉ ุงฺฉุงูุช ุงูุชุฎุงุจ ฺฉูุฏ');
        return;
      }
      
      if (botType === 'hashtag' && !target) {
        showNotification('โ ูุทูุง ฺฉ ูุดุชฺฏ ุงูุชุฎุงุจ ฺฉูุฏ');
        return;
      }
      
      startBtn.disabled = true;
      startBtn.textContent = 'โณ ุฏุฑ ุญุงู ุดุฑูุน...';

      try {
        const response = await fetch('/start', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({
            username,
            type: botType,
            target,
            sortType,
            startTime,
          })
        });

        const data = await response.json();
        if (response.ok) {
          showNotification('โ ุฑุจุงุช ุจุง ููููุช ุดุฑูุน ุดุฏ');
        } else {
          showNotification(`โ ${data.error || 'ุฎุทุง ุฏุฑ ุดุฑูุน ุฑุจุงุช'}`);
          startBtn.disabled = false;
          startBtn.textContent = 'โถ๏ธ ุดุฑูุน ุฑุจุงุช';
        }
      } catch (error) {
        showNotification('โ ุฎุทุง ุฏุฑ ุงุฑุชุจุงุท ุจุง ุณุฑูุฑ');
        startBtn.disabled = false;
        startBtn.textContent = 'โถ๏ธ ุดุฑูุน ุฑุจุงุช';
      }
    });
  }
  
  // Stop form handler
  const stopForm = document.getElementById('stop-form');
  if (stopForm) {
    stopForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const stopBtn = document.getElementById('stop-btn');
      const username = document.querySelector('input[name="username"]').value;
      
      stopBtn.disabled = true;
      stopBtn.textContent = 'โณ ุฏุฑ ุญุงู ุชููู...';
      
      try {
        const response = await fetch('/stop', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({ username })
        });
        
        const data = await response.json();
        if (response.ok) {
          showNotification('โ ุฑุจุงุช ุจุง ููููุช ูุชููู ุดุฏ');
        } else {
          showNotification(`โ ${data.error || 'ุฎุทุง ุฏุฑ ุชููู ุฑุจุงุช'}`);
          stopBtn.disabled = false;
          stopBtn.textContent = 'โน๏ธ ุชููู ุฑุจุงุช';
        }
      } catch (error) {
        showNotification('โ ุฎุทุง ุฏุฑ ุงุฑุชุจุงุท ุจุง ุณุฑูุฑ');
        stopBtn.disabled = false;
        stopBtn.textContent = 'โน๏ธ ุชููู ุฑุจุงุช';
      }
    });
  }

  // WebSocket for bot status
  function initWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const ws = new WebSocket(`${protocol}//${window.location.host}`);

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.status) {
        const startForm = document.getElementById('start-form');
        const stopForm = document.getElementById('stop-form');
        
        if (data.status === 'running') {
          botIsRunning = true;
          startForm.style.display = 'none';
          stopForm.style.display = 'block';
        } else if (data.status === 'stopped' || data.status === 'idle' || data.status === 'error' || data.status === 'paused') {
          botIsRunning = false;
          startForm.style.display = 'block';
          stopForm.style.display = 'none';
        }
      }
    };

    ws.onerror = (error) => console.error('WebSocket error:', error);
    ws.onclose = () => setTimeout(initWebSocket, 3000);
  }

  function showNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
  }

  initWebSocket();
})();
</script>

<%- include('partials/footer') %>
