<div class="dashboard-main">
  <% if (typeof error !== 'undefined' && error) { %>
    <div class="alert alert-error">
      <span class="alert-icon">âš ï¸</span>
      <div class="alert-content"><%= error %></div>
    </div>
  <% } %>

  <!-- Header -->
  <div class="dashboard-header">
    <div class="header-content">
      <h1>ğŸ¤– Ø±Ø¨Ø§Øª Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…</h1>
      <p class="header-subtitle">Ù…Ø¯ÛŒØ±ÛŒØª Ø®ÙˆØ¯Ú©Ø§Ø± ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…</p>
    </div>
    <% if (selectedAccount) { %>
      <div class="account-badge">
        <span class="badge-icon">âœ“</span>
        <span class="badge-text"><%= selectedAccount %></span>
      </div>
    <% } %>
  </div>

  <% if (selectedAccount && accounts && accounts.length) { %>
    <!-- Main Grid -->
    <div class="sections-grid">
      <!-- Accounts -->
      <section class="section">
        <div class="section-header">
          <h2>ğŸ” Ø§Ú©Ø§Ù†Øªâ€ŒÙ‡Ø§</h2>
          <button id="add-account-btn" class="btn-primary btn-add-account">+ Ø§ÙØ²ÙˆØ¯Ù† Ø§Ú©Ø§Ù†Øª</button>
        </div>
        <div class="accounts-container">
          <% accounts.forEach(function(account){ %>
            <div class="account-item <%= selectedAccount === account.username ? 'selected' : '' %>">
              <div class="account-info">
                <span class="account-status"></span>
                <span class="account-name"><%= account.username %></span>
              </div>
              <div class="account-actions">
                <% if (selectedAccount === account.username) { %>
                  <span class="badge-selected">Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡</span>
                <% } else { %>
                  <form action="/switch-account" method="POST" style="display:inline">
                    <input type="hidden" name="username" value="<%= account.username %>">
                    <button type="submit" class="btn-action">Ø§Ù†ØªØ®Ø§Ø¨</button>
                  </form>
                <% } %>
                <form action="/remove-account" method="POST" style="display:inline">
                  <input type="hidden" name="username" value="<%= account.username %>">
                  <button type="submit" class="btn-action btn-remove">ğŸ—‘</button>
                </form>
              </div>
            </div>
          <% }) %>
        </div>
      </section>

      <!-- Hashtags -->
      <section class="section">
        <div class="section-header">
          <h2>ğŸ·ï¸ Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§</h2>
        </div>
        <form id="hashtag-form" class="hashtag-form" action="/add-hashtag" method="POST">
          <div class="form-input-group">
            <input id="hashtag-input" name="hashtag" type="text" placeholder="Ù‡Ø´ØªÚ¯ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..." required>
            <button type="submit" class="btn-submit">Ø§ÙØ²ÙˆØ¯Ù†</button>
          </div>
        </form>
        <div id="hashtags-list" class="hashtags-container">
          <% if (hashtags && hashtags.length) { %>
            <% hashtags.forEach(function(h){ %>
              <div class="hashtag-item">
                <span class="hashtag-name">#<%= h %></span>
                <form action="/remove-hashtag" method="POST" style="display:inline;">
                  <input type="hidden" name="hashtag" value="<%= h %>">
                  <button class="btn-remove-tag">ğŸ—‘</button>
                </form>
              </div>
            <% }) %>
          <% } else { %>
            <div class="log-empty">Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ù‡Ø´ØªÚ¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div>
          <% } %>
        </div>
      </section>

      <!-- Bot Controls -->
      <section class="section section-full">
        <div class="section-header"><h2>âš™ï¸ Ú©Ù†ØªØ±Ù„ Ø±Ø¨Ø§Øª</h2></div>
        <div class="bot-panel">
          <form id="start-form" action="/start" method="POST">
            <input type="hidden" name="username" value="<%= selectedAccount %>">
            <div class="form-row">
              <div class="form-group">
                <label>Ù†ÙˆØ¹ Ø¹Ù…Ù„ÛŒØ§Øª</label>
                <select name="type" required>
                  <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                  <option value="hashtag">ğŸ·ï¸ Ù‡Ø´ØªÚ¯</option>
                  <option value="explore">ğŸ” Ø§Ú©Ø³Ù¾Ù„ÙˆØ±</option>
                </select>
              </div>
              <div class="form-group">
                <label>Ù‡Ø¯Ù</label>
                <select id="target-select" name="target" required>
                  <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                  <% if (hashtags && hashtags.length) { %>
                    <% hashtags.forEach(function(h){ %>
                      <option value="<%= h %>">#<%= h %></option>
                    <% }) %>
                  <% } %>
                </select>
              </div>
              <div class="form-group">
                <label>Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                <input type="time" name="startTime">
              </div>
            </div>
            <button type="submit" class="btn-start">â–¶ï¸ Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª</button>
          </form>

          <form id="stop-form" action="/stop" method="POST">
            <input type="hidden" name="username" value="<%= selectedAccount %>">
            <button type="submit" class="btn-stop">â¹ï¸ ØªÙˆÙ‚Ù Ø±Ø¨Ø§Øª</button>
          </form>
        </div>

        <!-- Status Area -->
        <div class="status-area">
          <div class="status-header">
            <h3>ğŸ“Š ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ</h3>
            <span class="status-light inactive"></span>
          </div>
          <div class="status-info">
            <div class="status-row">
              <span class="label">ÙˆØ¶Ø¹ÛŒØª Ø±Ø¨Ø§Øª:</span>
              <span class="value" id="bot-status">ØºÛŒØ±ÙØ¹Ø§Ù„</span>
            </div>
            <div class="status-row">
              <span class="label">ÙØ¹Ø§Ù„ÛŒØª:</span>
              <span class="value" id="bot-activity">Ø¨Ø¯ÙˆÙ† ÙØ¹Ø§Ù„ÛŒØª</span>
            </div>
          </div>
        </div>

        <!-- Activity Log -->
        <div class="activity-area">
          <h3>ğŸ“ Ú¯Ø²Ø§Ø±Ø´ ÙØ¹Ø§Ù„ÛŒØª</h3>
          <div class="activity-log" id="activity-log">
            <div class="log-entry">
              <span class="log-time">-</span>
              <span class="log-msg">Ù…Ù†ØªØ¸Ø± Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª...</span>
            </div>
          </div>
        </div>
      </section>
    </div>

  <% } else { %>
    <!-- Empty State -->
    <div class="empty-state">
      <div class="empty-icon">ğŸš€</div>
      <h2>Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯ÛŒØ¯!</h2>
      <p>Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø§Ú©Ø§Ù†Øª Instagram Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯</p>
      <button id="add-account-btn" class="btn-primary btn-large">+ Ø§ÙØ²ÙˆØ¯Ù† Ø§Ú©Ø§Ù†Øª Ø§ÙˆÙ„</button>
    </div>
  <% } %>

  <!-- Add Account Modal -->
  <div id="add-account-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h2>ğŸ” Ø§ÙØ²ÙˆØ¯Ù† Ø§Ú©Ø§Ù†Øª Ø¬Ø¯ÛŒØ¯</h2>
      <p class="modal-subtitle">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p>
      
      <form action="/add-account" method="POST" class="login-modal-form">
        <div class="form-group">
          <label for="modal-username">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Instagram</label>
          <input 
            type="text" 
            id="modal-username"
            name="username" 
            placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ" 
            required
            minlength="3"
          >
        </div>

        <div class="form-group">
          <label for="modal-password">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
          <input 
            type="password" 
            id="modal-password"
            name="password" 
            placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±" 
            required
            minlength="6"
          >
        </div>

        <button type="submit" class="btn-primary btn-large">ÙˆØ±ÙˆØ¯ Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù†</button>
      </form>

      <div class="modal-info">
        <p class="info-item">
          <span class="info-icon">ğŸ”’</span>
          Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø´Ù…Ø§ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø§ÛŒÙ…Ù† Ø§Ø³Øª
        </p>
        <p class="info-item">
          <span class="info-icon">âœ…</span>
          Ø§Ú¯Ø± Ø¯Ùˆ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ ÙØ¹Ø§Ù„ Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø§Ù¾ Instagram Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯
        </p>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  // Modal handling
  const addAccountBtn = document.getElementById('add-account-btn');
  const addAccountModal = document.getElementById('add-account-modal');
  const closeBtn = document.querySelector('.close-btn');

  if (addAccountBtn && addAccountModal) {
    addAccountBtn.addEventListener('click', () => {
      addAccountModal.classList.add('show');
    });
  }

  if (closeBtn && addAccountModal) {
    closeBtn.addEventListener('click', () => {
      addAccountModal.classList.remove('show');
    });
  }

  // Click outside modal to close
  addAccountModal?.addEventListener('click', (e) => {
    if (e.target === addAccountModal) {
      addAccountModal.classList.remove('show');
    }
  });

  // Add hashtag with AJAX
  const hashtagForm = document.getElementById('hashtag-form');
  if (hashtagForm) {
    hashtagForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const hashtag = document.getElementById('hashtag-input').value;

      try {
        const response = await fetch('/add-hashtag', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `hashtag=${encodeURIComponent(hashtag)}`
        });

        if (response.ok) {
          // Add hashtag to list
          const hashtags = document.getElementById('hashtags-list');
          const item = document.createElement('div');
          item.className = 'hashtag-item';
          item.innerHTML = `
            <span class="hashtag-name">#${hashtag}</span>
            <form action="/remove-hashtag" method="POST" style="display:inline;">
              <input type="hidden" name="hashtag" value="${hashtag}">
              <button type="submit" class="btn-remove-tag">ğŸ—‘</button>
            </form>
          `;
          hashtags.appendChild(item);

          // Clear input
          document.getElementById('hashtag-input').value = '';
          
          // Update target select
          const targetSelect = document.getElementById('target-select');
          const option = document.createElement('option');
          option.value = hashtag;
          option.textContent = '#' + hashtag;
          targetSelect.appendChild(option);

          showNotification('âœ… Ù‡Ø´ØªÚ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
        }
      } catch (error) {
        console.error('Error:', error);
        showNotification('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ù‡Ø´ØªÚ¯');
      }
    });
  }

  // WebSocket for bot status
  function initWebSocket() {
    try {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const ws = new WebSocket(protocol + '//' + window.location.host);

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.status) {
          const status = document.getElementById('bot-status');
          if (status) {
            status.textContent = data.status === 'running' ? 'ğŸŸ¢ ÙØ¹Ø§Ù„' : 'ğŸ”´ ØºÛŒØ±ÙØ¹Ø§Ù„';
          }
        }
        if (data.message) {
          const activity = document.getElementById('bot-activity');
          if (activity) activity.textContent = data.message;
          
          const log = document.getElementById('activity-log');
          if (log) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const time = new Date().toLocaleTimeString('fa-IR');
            entry.innerHTML = `<span class="log-time">${time}</span><span class="log-msg">${data.message}</span>`;
            log.insertBefore(entry, log.firstChild);
            
            while (log.children.length > 20) {
              log.removeChild(log.lastChild);
            }
          }
        }
      };

      ws.onerror = (error) => console.error('WebSocket error:', error);
      ws.onclose = () => setTimeout(initWebSocket, 3000);
    } catch (e) {
      console.error('WebSocket error:', e);
    }
  }

  function showNotification(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      bottom: 2rem;
      right: 1rem;
      background: white;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 999;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
      notification.remove();
    }, 3000);
  }

  if (document.querySelector('.status-area')) {
    initWebSocket();
  }
})();
</script>
