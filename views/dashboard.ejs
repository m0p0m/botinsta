<link rel="stylesheet" href="/css/style.css">
<div class="dashboard">
  <div class="header">
    <h1>Instagram Bot</h1>
  </div>

  <% if (selectedAccount) { %>
    <div class="account-switcher">
      <form action="/switch-account" method="POST">
        <select name="username" onchange="this.form.submit()">
          <% accounts.forEach(account => { %>
            <option value="<%= account.username %>" <%= account.username === selectedAccount.username ? 'selected' : '' %>><%= account.username %></option>
          <% }) %>
        </select>
      </form>
    </div>

    <div class="profile-info">
      <img src="<%= profile.profile_pic_url %>" alt="Profile Picture">
      <div>
        <h2><%= profile.full_name %></h2>
        <p><%= profile.biography %></p>
      </div>
    </div>

    <div class="profile-stats">
      <div class="stat">
        <h3><%= profile.followers %></h3>
        <p>Followers</p>
      </div>
      <div class="stat">
        <h3><%= profile.following %></h3>
        <p>Following</p>
      </div>
      <div class="stat">
        <h3><%= profile.posts %></h3>
        <p>Posts</p>
      </div>
    </div>
  <% } %>

  <div class="bot-controls">
    <form id="start-form" action="/start" method="POST">
      <input type="hidden" name="username" value="<%= selectedAccount ? selectedAccount.username : '' %>">
      <select name="type" <%= !selectedAccount ? 'disabled' : '' %>>
        <option value="hashtag">Hashtag</option>
        <option value="explore">Explore</option>
      </select>
      <input type="text" name="target" placeholder="Enter hashtag" <%= !selectedAccount ? 'disabled' : '' %>>
      <button type="submit" <%= !selectedAccount ? 'disabled' : '' %>>Start</button>
    </form>
    <form id="stop-form" action="/stop" method="POST">
      <input type="hidden" name="username" value="<%= selectedAccount ? selectedAccount.username : '' %>">
      <button type="submit" <%= !selectedAccount ? 'disabled' : '' %>>Stop</button>
    </form>
  </div>

  <div class="status-panel">
    <h3>Bot Status</h3>
    <p><strong>Status:</strong> <span id="status">Idle</span></p>
    <p><strong>Message:</strong> <span id="message"></span></p>
  </div>

  <% if (!selectedAccount) { %>
    <div class="add-account-section">
      <p>Please add an account to start using the bot.</p>
      <button id="add-account-btn">Add Account</button>
    </div>
  <% } %>
</div>

<div id="add-account-modal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h2>Add Account</h2>
    <% if (typeof error !== 'undefined' && error) { %>
      <p class="error"><%= error %></p>
    <% } %>
    <form action="/add-account" method="POST">
      <input type="text" name="username" placeholder="Username" required>
      <input type="password" name="password" placeholder="Password" required>
      <button type="submit">Add Account</button>
    </form>
  </div>
</div>

<script>
  const socket = new WebSocket('ws://' + window.location.host);
  const statusEl = document.getElementById('status');
  const messageEl = document.getElementById('message');
  const typeSelect = document.querySelector('select[name="type"]');
  const targetInput = document.querySelector('input[name="target"]');
  const addAccountBtn = document.getElementById('add-account-btn');
  const modal = document.getElementById('add-account-modal');
  const closeBtn = document.querySelector('.close-btn');

  if (addAccountBtn) {
    addAccountBtn.addEventListener('click', () => {
      modal.style.display = 'block';
    });
  }

  if (closeBtn) {
    closeBtn.addEventListener('click', () => {
      modal.style.display = 'none';
    });
  }

  window.addEventListener('click', (event) => {
    if (event.target == modal) {
      modal.style.display = 'none';
    }
  });

  if (typeSelect) {
    typeSelect.addEventListener('change', () => {
      if (typeSelect.value === 'explore') {
        targetInput.style.display = 'none';
      } else {
        targetInput.style.display = 'block';
      }
    });
  }

  socket.onmessage = (event) => {
    const data = JSON.parse(event.data);
    statusEl.textContent = data.status;
    messageEl.textContent = data.message;
  };
</script>
