<div class="dashboard">
  <!-- Tab Navigation -->
  <div class="tab-nav">
    <button class="tab-link active" data-tab="account">Account</button>
    <button class="tab-link" data-tab="hashtags">Hashtags</button>
    <button class="tab-link" data-tab="bot">Bot</button>
  </div>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- Account Tab -->
    <div id="account" class="tab-pane active">
      <% if (selectedAccount) { %>
        <div class="account-switcher">
          <form action="/switch-account" method="POST">
            <select name="username" onchange="this.form.submit()">
              <% accounts.forEach(account => { %>
                <option value="<%= account.username %>" <%= account.username === selectedAccount.username ? 'selected' : '' %>>
                  <%= account.username %>
                </option>
              <% }) %>
            </select>
            <span id="online-indicator" class="online-indicator" style="display: none;"></span>
          </form>
        </div>
        <div class="profile-info">
          <img src="<%= profile.profile_pic_url %>" alt="Profile Picture">
          <div>
            <h2><%= profile.full_name %></h2>
            <p><%= profile.biography %></p>
          </div>
        </div>
        <div class="profile-stats">
          <div class="stat"><h3><%= profile.followers %></h3><p>Followers</p></div>
          <div class="stat"><h3><%= profile.following %></h3><p>Following</p></div>
          <div class="stat"><h3><%= profile.posts %></h3><p>Posts</p></div>
        </div>
      <% } else { %>
        <div class="add-account-section">
          <p>Please add an account to start using the bot.</p>
          <button id="add-account-btn">Add Account</button>
        </div>
      <% } %>
    </div>

    <!-- Hashtags Tab -->
    <div id="hashtags" class="tab-pane">
        <div class="hashtag-management">
          <h3>Hashtags</h3>
          <form action="/add-hashtag" method="POST">
            <input type="text" name="hashtag" placeholder="Add a hashtag" required>
            <button type="submit">Add</button>
          </form>
          <ul>
            <% hashtags.forEach(hashtag => { %>
              <li>
                <%= hashtag %>
                <form action="/remove-hashtag" method="POST" style="display: inline;">
                  <input type="hidden" name="hashtag" value="<%= hashtag %>">
                  <button type="submit" class="remove-btn">&times;</button>
                </form>
              </li>
            <% }) %>
          </ul>
        </div>
    </div>

    <!-- Bot Tab -->
    <div id="bot" class="tab-pane">
        <div class="bot-controls">
          <form id="start-form" action="/start" method="POST">
            <input type="hidden" name="username" value="<%= selectedAccount ? selectedAccount.username : '' %>">
            <select name="type" <%= !selectedAccount ? 'disabled' : '' %>>
              <option value="hashtag">Hashtag</option>
              <option value="explore">Explore</option>
            </select>
            <select name="target" <%= !selectedAccount ? 'disabled' : '' %>>
              <% hashtags.forEach(hashtag => { %>
                <option value="<%= hashtag %>"><%= hashtag %></option>
              <% }) %>
            </select>
            <input type="time" name="startTime" <%= !selectedAccount ? 'disabled' : '' %>>
            <button type="submit" <%= !selectedAccount ? 'disabled' : '' %>>Start</button>
          </form>
          <form id="stop-form" action="/stop" method="POST">
            <input type="hidden" name="username" value="<%= selectedAccount ? selectedAccount.username : '' %>">
            <button type="submit" <%= !selectedAccount ? 'disabled' : '' %>>Stop</button>
          </form>
        </div>
        <div class="status-panel">
          <h3>Bot Status</h3>
          <p><strong>Status:</strong> <span id="status">Idle</span></p>
        </div>
        <div class="activity-log">
          <h3>Activity Log</h3>
          <ul id="log-list"></ul>
        </div>
    </div>
  </div>

  <% if (!selectedAccount) { %>
    <!-- Add Account Modal -->
    <div id="add-account-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>Add Account</h2>
        <% if (typeof error !== 'undefined' && error) { %>
          <p class="error"><%= error %></p>
        <% } %>
        <form action="/add-account" method="POST">
          <input type="text" name="username" placeholder="Username" required>
          <input type="password" name="password" placeholder="Password" required>
          <button type="submit">Add Account</button>
        </form>
      </div>
    </div>
  <% } %>
</div>

<script>
  // WebSocket logic
  const socket = new WebSocket('ws://' + window.location.host);
  const statusEl = document.getElementById('status');
  const logList = document.getElementById('log-list');
  const onlineIndicator = document.getElementById('online-indicator');

  socket.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (statusEl) statusEl.textContent = data.status;

    if (onlineIndicator) {
      onlineIndicator.style.display = data.status === 'running' ? 'inline-block' : 'none';
    }

    if (logList) {
      const logItem = document.createElement('li');
      logItem.textContent = `[${new Date().toLocaleTimeString()}] ${data.message}`;
      logList.appendChild(logItem);
      logList.scrollTop = logList.scrollHeight;
    }
  };

  // Tab switching logic
  const tabLinks = document.querySelectorAll('.tab-link');
  const tabPanes = document.querySelectorAll('.tab-pane');

  tabLinks.forEach(link => {
    link.addEventListener('click', () => {
      const tab = link.dataset.tab;

      tabLinks.forEach(l => l.classList.remove('active'));
      link.classList.add('active');

      tabPanes.forEach(pane => {
        if (pane.id === tab) {
          pane.classList.add('active');
        } else {
          pane.classList.remove('active');
        }
      });
    });
  });

  // Modal logic
  const addAccountBtn = document.getElementById('add-account-btn');
  const modal = document.getElementById('add-account-modal');
  const closeBtn = document.querySelector('.close-btn');

  if (addAccountBtn) {
    addAccountBtn.addEventListener('click', () => {
      if(modal) modal.style.display = 'block';
    });
  }

  if (closeBtn) {
    closeBtn.addEventListener('click', () => {
      if(modal) modal.style.display = 'none';
    });
  }

  window.addEventListener('click', (event) => {
    if (event.target == modal) {
      if(modal) modal.style.display = 'none';
    }
  });

  // Dynamic target input for bot controls
  const typeSelect = document.querySelector('select[name="type"]');
  const targetInput = document.querySelector('select[name="target"]');
  if (typeSelect) {
    typeSelect.addEventListener('change', () => {
      if (typeSelect.value === 'explore') {
        targetInput.style.display = 'none';
      } else {
        targetInput.style.display = 'block';
      }
    });
  }
</script>
