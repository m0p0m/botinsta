<div class="dashboard-main">
  <% if (typeof error !== 'undefined' && error) { %>
    <div class="alert alert-error">
      <span class="alert-icon">âš ï¸</span>
      <div class="alert-content"><%= error %></div>
    </div>
  <% } %>

  <!-- Header -->
  <div class="dashboard-header">
    <div class="header-content">
      <h1>ğŸ¤– Ø±Ø¨Ø§Øª Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…</h1>
      <p class="header-subtitle">Ù…Ø¯ÛŒØ±ÛŒØª Ø®ÙˆØ¯Ú©Ø§Ø± ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…</p>
    </div>
    <% if (selectedAccount) { %>
      <div class="account-badge">
        <span class="badge-icon">âœ“</span>
        <span class="badge-text"><%= selectedAccount %></span>
      </div>
    <% } %>
  </div>

  <% if (accounts && accounts.length) { %>
    <!-- Main Grid -->
    <div class="sections-grid">
      <!-- Accounts -->
      <section class="section">
        <div class="section-header">
          <h2>ğŸ” Ø§Ú©Ø§Ù†Øªâ€ŒÙ‡Ø§</h2>
          <button id="add-account-btn" class="btn-primary btn-add-account">+ Ø§ÙØ²ÙˆØ¯Ù† Ø§Ú©Ø§Ù†Øª</button>
        </div>
        <div class="accounts-container">
          <% accounts.forEach(function(account){ %>
            <div class="account-item <%= selectedAccount === account.username ? 'selected' : '' %>">
              <div class="account-info">
                <span class="account-status"></span>
                <span class="account-name"><%= account.username %></span>
              </div>
              <div class="account-actions">
                <% if (selectedAccount === account.username) { %>
                  <span class="badge-selected">Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡</span>
                <% } else { %>
                  <form action="/switch-account" method="POST" style="display:inline">
                    <input type="hidden" name="username" value="<%= account.username %>">
                    <button type="submit" class="btn-action">Ø§Ù†ØªØ®Ø§Ø¨</button>
                  </form>
                <% } %>
                <form action="/remove-account" method="POST" style="display:inline">
                  <input type="hidden" name="username" value="<%= account.username %>">
                  <button type="submit" class="btn-action btn-remove">ğŸ—‘</button>
                </form>
              </div>
            </div>
          <% }) %>
        </div>
      </section>

      <!-- Hashtags -->
      <section class="section">
        <div class="section-header">
          <h2>ğŸ·ï¸ Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§</h2>
        </div>
        <form id="hashtag-form" class="hashtag-form" action="/add-hashtag" method="POST">
          <div class="form-input-group">
            <input id="hashtag-input" name="hashtag" type="text" placeholder="Ù‡Ø´ØªÚ¯ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..." required>
            <button type="submit" class="btn-submit">Ø§ÙØ²ÙˆØ¯Ù†</button>
          </div>
        </form>
        <div id="hashtags-list" class="hashtags-container">
          <% if (hashtags && hashtags.length) { %>
            <% hashtags.forEach(function(h){ %>
              <div class="hashtag-item">
                <span class="hashtag-name">#<%= h %></span>
                <form action="/remove-hashtag" method="POST" style="display:inline;">
                  <input type="hidden" name="hashtag" value="<%= h %>">
                  <button class="btn-remove-tag">ğŸ—‘</button>
                </form>
              </div>
            <% }) %>
          <% } else { %>
            <div class="log-empty">Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ù‡Ø´ØªÚ¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div>
          <% } %>
        </div>
      </section>

      <!-- Bot Controls -->
      <section class="section section-full">
        <div class="section-header"><h2>âš™ï¸ Ú©Ù†ØªØ±Ù„ Ø±Ø¨Ø§Øª</h2></div>
        <div class="bot-panel">
          <form id="start-form" action="/start" method="POST">
            <input type="hidden" name="username" value="<%= selectedAccount %>">
            <div class="form-row">
              <div class="form-group">
                <label>Ù†ÙˆØ¹ Ø¹Ù…Ù„ÛŒØ§Øª</label>
                <select name="type" id="bot-type" required>
                  <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                  <option value="hashtag">ğŸ·ï¸ Ù‡Ø´ØªÚ¯</option>
                  <option value="explore">ğŸ” Ø§Ú©Ø³Ù¾Ù„ÙˆØ±</option>
                </select>
              </div>
              <div class="form-group">
                <label>Ù‡Ø¯Ù (Ù‡Ø´ØªÚ¯)</label>
                <select id="target-select" name="target" required>
                  <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                  <% if (hashtags && hashtags.length) { %>
                    <% hashtags.forEach(function(h){ %>
                      <option value="<%= h %>">#<%= h %></option>
                    <% }) %>
                  <% } %>
                </select>
              </div>
              <div class="form-group">
                <label>Ù†ÙˆØ¹ Ù¾Ø³Øªâ€ŒÙ‡Ø§</label>
                <select name="sortType" id="sort-type" required>
                  <option value="recent">ğŸ†• Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†</option>
                  <option value="top">â­ Ø¨Ø±ØªØ±ÛŒÙ†</option>
                </select>
              </div>
              <div class="form-group">
                <label>Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                <input type="time" name="startTime">
              </div>
            </div>
            <button type="submit" id="start-btn" class="btn-start">â–¶ï¸ Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª</button>
          </form>

          <form id="stop-form" action="/stop" method="POST" style="display:none;">
            <input type="hidden" name="username" value="<%= selectedAccount %>">
            <button type="submit" id="stop-btn" class="btn-stop">â¹ï¸ ØªÙˆÙ‚Ù Ø±Ø¨Ø§Øª</button>
          </form>
          
          <div id="bot-starting-indicator" class="bot-starting-indicator" style="display: none;">
            <div class="indicator-content">
              <div class="spinner"></div>
              <span>Ø¯Ø± Ø­Ø§Ù„ Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª...</span>
            </div>
          </div>
        </div>

        <!-- Status Area -->
        <div class="status-area">
          <div class="status-header">
            <h3>ğŸ“Š ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ</h3>
            <span class="status-light inactive" id="status-light"></span>
          </div>
          <div class="status-info">
            <div class="status-row">
              <span class="label">ÙˆØ¶Ø¹ÛŒØª Ø±Ø¨Ø§Øª:</span>
              <span class="value" id="bot-status">ğŸ”´ ØºÛŒØ±ÙØ¹Ø§Ù„</span>
            </div>
            <div class="status-row" id="current-target-row" style="display: none;">
              <span class="label">Ù‡Ø´ØªÚ¯ ÙØ¹Ù„ÛŒ:</span>
              <span class="value" id="current-target">-</span>
            </div>
            <div class="status-row">
              <span class="label">ØªØ¹Ø¯Ø§Ø¯ Ù„Ø§ÛŒÚ©:</span>
              <span class="value" id="bot-likes">0</span>
            </div>
            <div class="status-row">
              <span class="label">ÙØ¹Ø§Ù„ÛŒØª:</span>
              <span class="value" id="bot-activity">Ø¨Ø¯ÙˆÙ† ÙØ¹Ø§Ù„ÛŒØª</span>
            </div>
          </div>
        </div>

        <!-- Activity Log -->
        <div class="activity-area">
          <div class="activity-header">
            <h3>ğŸ“ Ú¯Ø²Ø§Ø±Ø´ ÙØ¹Ø§Ù„ÛŒØª</h3>
            <button id="clear-log-btn" class="btn-clear-log" title="Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯">ğŸ—‘ï¸</button>
          </div>
          <div class="activity-log" id="activity-log">
            <div class="log-entry log-info">
              <span class="log-time">-</span>
              <span class="log-msg">Ù…Ù†ØªØ¸Ø± Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª...</span>
            </div>
          </div>
        </div>
      </section>
    </div>

  <% } else { %>
    <!-- Empty State -->
    <div class="empty-state">
      <div class="empty-icon">ğŸš€</div>
      <h2>Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯ÛŒØ¯!</h2>
      <p>Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø§Ú©Ø§Ù†Øª Instagram Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯</p>
      <button id="add-account-btn-empty" class="btn-primary btn-large">+ Ø§ÙØ²ÙˆØ¯Ù† Ø§Ú©Ø§Ù†Øª Ø§ÙˆÙ„</button>
    </div>
  <% } %>

  <!-- Add Account Modal -->
  <div id="add-account-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h2>ğŸ” Ø§ÙØ²ÙˆØ¯Ù† Ø§Ú©Ø§Ù†Øª Ø¬Ø¯ÛŒØ¯</h2>
      <p class="modal-subtitle">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p>
      
      <form action="/add-account" method="POST" class="login-modal-form">
        <div class="form-group">
          <label for="modal-username">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Instagram</label>
          <input 
            type="text" 
            id="modal-username"
            name="username" 
            placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ" 
            required
            minlength="3"
          >
        </div>

        <div class="form-group">
          <label for="modal-password">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
          <input 
            type="password" 
            id="modal-password"
            name="password" 
            placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±" 
            autocomplete="current-password"
            required
            minlength="6"
          >
        </div>

        <button type="submit" class="btn-primary btn-large">ÙˆØ±ÙˆØ¯ Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù†</button>
      </form>

      <div class="modal-info">
        <p class="info-item">
          <span class="info-icon">ğŸ”’</span>
          Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø´Ù…Ø§ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø§ÛŒÙ…Ù† Ø§Ø³Øª
        </p>
        <p class="info-item">
          <span class="info-icon">âœ…</span>
          Ø§Ú¯Ø± Ø¯Ùˆ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ ÙØ¹Ø§Ù„ Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø§Ù¾ Instagram Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯
        </p>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  // Modal handling: attach to all add-account buttons (there may be multiple)
  const addAccountBtns = document.querySelectorAll('#add-account-btn, #add-account-btn-empty, .btn-add-account');
  const addAccountModal = document.getElementById('add-account-modal');
  const closeBtn = document.querySelector('.close-btn');

  if (addAccountBtns && addAccountModal) {
    addAccountBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        addAccountModal.classList.add('show');
      });
    });
  }

  if (closeBtn && addAccountModal) {
    closeBtn.addEventListener('click', () => {
      addAccountModal.classList.remove('show');
    });
  }

  // Click outside modal to close
  addAccountModal?.addEventListener('click', (e) => {
    if (e.target === addAccountModal) {
      addAccountModal.classList.remove('show');
    }
  });

  // Add hashtag with AJAX
  const hashtagForm = document.getElementById('hashtag-form');
  if (hashtagForm) {
    hashtagForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const hashtag = document.getElementById('hashtag-input').value;

      try {
        const response = await fetch('/add-hashtag', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `hashtag=${encodeURIComponent(hashtag)}`
        });

        if (response.ok) {
          // Add hashtag to list
          const hashtags = document.getElementById('hashtags-list');
          const item = document.createElement('div');
          item.className = 'hashtag-item';
          item.innerHTML = `
            <span class="hashtag-name">#${hashtag}</span>
            <form action="/remove-hashtag" method="POST" style="display:inline;">
              <input type="hidden" name="hashtag" value="${hashtag}">
              <button type="submit" class="btn-remove-tag">ğŸ—‘</button>
            </form>
          `;
          hashtags.appendChild(item);

          // Clear input
          document.getElementById('hashtag-input').value = '';
          
          // Update target select
          const targetSelect = document.getElementById('target-select');
          const option = document.createElement('option');
          option.value = hashtag;
          option.textContent = '#' + hashtag;
          targetSelect.appendChild(option);

          showNotification('âœ… Ù‡Ø´ØªÚ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
        }
      } catch (error) {
        console.error('Error:', error);
        showNotification('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ù‡Ø´ØªÚ¯');
      }
    });
  }

  // Bot state management
  let botIsRunning = false;
  let stopBtnTimeout = null;

  // Start form handler
  const startForm = document.getElementById('start-form');
  const botTypeSelect = document.getElementById('bot-type');
  const targetSelect = document.getElementById('target-select');
  
  // Show/hide target select based on bot type
  if (botTypeSelect && targetSelect) {
    botTypeSelect.addEventListener('change', () => {
      if (botTypeSelect.value === 'hashtag') {
        targetSelect.closest('.form-group').style.display = 'flex';
        targetSelect.required = true;
      } else {
        targetSelect.closest('.form-group').style.display = 'none';
        targetSelect.required = false;
      }
    });
    
    // Initial state
    if (botTypeSelect.value !== 'hashtag') {
      targetSelect.closest('.form-group').style.display = 'none';
      targetSelect.required = false;
    }
  }
  
  if (startForm) {
    startForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const startBtn = document.getElementById('start-btn');
      const botType = document.getElementById('bot-type').value;
      const target = document.getElementById('target-select').value;
      const sortType = document.getElementById('sort-type').value;
      const startTime = document.querySelector('input[name="startTime"]').value;
      const usernameInput = document.querySelector('input[name="username"]');
      let username = usernameInput ? usernameInput.value : null;
      
      // If username is empty, try to get it from the form's hidden input
      if (!username || username.trim() === '') {
        const hiddenUsername = document.querySelector('#start-form input[name="username"]');
        username = hiddenUsername ? hiddenUsername.value : null;
      }
      
      // Debug log
      console.log('Form data:', { username, botType, target, sortType, startTime });
      console.log('Username input value:', usernameInput ? usernameInput.value : 'not found');
      
      if (!username || username.trim() === '') {
        showNotification('âŒ Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø§Ú©Ø§Ù†Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
        console.error('Username is empty!');
        return;
      }
      
      if (botType === 'hashtag' && !target) {
        showNotification('âŒ Ù„Ø·ÙØ§ ÛŒÚ© Ù‡Ø´ØªÚ¯ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
        return;
      }
      
      if (!botType) {
        showNotification('âŒ Ù„Ø·ÙØ§ Ù†ÙˆØ¹ Ø¹Ù…Ù„ÛŒØ§Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
        return;
      }
      
      startBtn.disabled = true;
      startBtn.textContent = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø´Ø±ÙˆØ¹...';
      
      // Show starting indicator
      const indicator = document.getElementById('bot-starting-indicator');
      if (indicator) indicator.style.display = 'block';
      
      // Ù†Ù…Ø§ÛŒØ´ Ø³Ø±ÛŒØ¹ stop Ù…ÙˆÙ‚Øª Ø­ØªÛŒ Ù‚Ø¨Ù„ wsØŒ Ø¯Ø±ØµÙˆØ±Øª Ø¹Ø¯Ù… Ø®Ø·Ø§ÛŒ ÙÙˆØ±ÛŒ
      document.getElementById('stop-form').style.display = 'block';
      document.getElementById('start-form').style.display = 'none';
      if (stopBtnTimeout) clearTimeout(stopBtnTimeout);
      // Ø§Ú¯Ø± Ø¨Ø¹Ø¯ Ø§Ø² 3 Ø«Ø§Ù†ÛŒÙ‡ Ù‡ÛŒÚ† Ù¾Ø§Ø³Ø®ÛŒ Ø§Ø² ws Ù†ÛŒØ§Ù…Ø¯ØŒ Ø¯Ú©Ù…Ù‡ Ù‡Ø§ Ø±Ø§ Ø¨Ù‡ Ø­Ø§Ù„Øª Ù‚Ø¨Ù„ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†
      stopBtnTimeout = setTimeout(() => {
        if (!botIsRunning) {
          document.getElementById('stop-form').style.display = 'none';
          document.getElementById('start-form').style.display = 'block';
          startBtn.disabled = false;
          startBtn.textContent = 'â–¶ï¸ Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª';
        }
      }, 3000);

      try {
        // Use URLSearchParams instead of FormData for better compatibility
        const params = new URLSearchParams();
        params.append('username', username || '');
        params.append('type', botType || '');
        params.append('target', target || '');
        params.append('sortType', sortType || 'recent');
        if (startTime) params.append('startTime', startTime);
        
        // Debug: Log form data
        console.log('Sending form data:', {
          username: username || 'EMPTY',
          type: botType || 'EMPTY',
          target: target || 'EMPTY',
          sortType: sortType || 'recent',
          startTime: startTime || 'none'
        });
        
        // Verify botType is not empty
        if (!botType || botType.trim() === '') {
          showNotification('âŒ Ù„Ø·ÙØ§ Ù†ÙˆØ¹ Ø¹Ù…Ù„ÛŒØ§Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
          startBtn.disabled = false;
          startBtn.textContent = 'â–¶ï¸ Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª';
          if (indicator) indicator.style.display = 'none';
          return;
        }
        
        const response = await fetch('/start', {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: params.toString()
        });
        
        let data;
        try {
          data = await response.json();
        } catch (jsonError) {
          console.error('Error parsing JSON response:', jsonError);
          const text = await response.text();
          console.error('Response text:', text);
          throw new Error('Ù¾Ø§Ø³Ø® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø² Ø³Ø±ÙˆØ±');
        }
        
        if (response.ok && data.success) {
          showNotification('âœ… ' + data.message);
          // Form will be hidden by WebSocket update
        } else {
          const errorMsg = data.error || data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª';
          console.error('Bot start error:', errorMsg, 'Status:', response.status);
          showNotification('âŒ ' + errorMsg);
          startBtn.disabled = false;
          startBtn.textContent = 'â–¶ï¸ Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª';
          if (indicator) indicator.style.display = 'none';
        }
      } catch (error) {
        console.error('Error starting bot:', error);
        showNotification('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±: ' + (error.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ'));
        startBtn.disabled = false;
        startBtn.textContent = 'â–¶ï¸ Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª';
        if (indicator) indicator.style.display = 'none';
      }
    });
  }
  
  // Stop form handler
  const stopForm = document.getElementById('stop-form');
  if (stopForm) {
    stopForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const stopBtn = document.getElementById('stop-btn');
      const username = document.querySelector('#stop-form input[name="username"]').value;
      
      stopBtn.disabled = true;
      stopBtn.textContent = 'â³ Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ‚Ù...';
      
      try {
        const params = new URLSearchParams();
        params.append('username', username);
        
        const response = await fetch('/stop', {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: params.toString()
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          showNotification('âœ… ' + data.message);
        } else {
          showNotification('âŒ ' + (data.error || 'Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ‚Ù Ø±Ø¨Ø§Øª'));
          stopBtn.disabled = false;
          stopBtn.textContent = 'â¹ï¸ ØªÙˆÙ‚Ù Ø±Ø¨Ø§Øª';
        }
      } catch (error) {
        console.error('Error stopping bot:', error);
        showNotification('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
        stopBtn.disabled = false;
        stopBtn.textContent = 'â¹ï¸ ØªÙˆÙ‚Ù Ø±Ø¨Ø§Øª';
      }
    });
  }

  function initWebSocket() {
    try {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}`;
      console.log('ğŸ”— Connecting to WebSocket:', wsUrl);
      
      const ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        console.log('âœ… WebSocket connection established');
        
        // Request current status after 1 second
        setTimeout(() => {
          if (ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'status_request' }));
          }
        }, 1000);
        
        showNotification('âœ… Ù…ØªØµÙ„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          console.log('ğŸ“¨ WebSocket message:', data);
          
          // Update UI
          handleBotStatusUpdate(data);
          
        } catch (e) {
          console.error('âŒ Error parsing WebSocket message:', e, 'Raw:', event.data);
        }
      };

      ws.onerror = (error) => {
        console.error('âŒ WebSocket error:', error);
        showNotification('âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
      };

      ws.onclose = (event) => {
        console.log('ğŸ”Œ WebSocket closed, reconnecting...', event.code, event.reason);
        showNotification('â³ Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„ØŒ Ø¯Ø± Ø­Ø§Ù„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯...');
        setTimeout(initWebSocket, 3000);
      };

      window.ws = ws;
      
    } catch (e) {
      console.error('âŒ WebSocket initialization error:', e);
      setTimeout(initWebSocket, 5000);
    }
  }

  // ØªØ§Ø¨Ø¹ handleBotStatusUpdate Ø±Ø§ Ø¨Ù‡ Ø§ÛŒÙ† Ø´Ú©Ù„ Ø¨Ù‡â€ŒØ±ÙˆØ² Ú©Ù†ÛŒØ¯:
  function handleBotStatusUpdate(data) {
    const { status, message, username, target, likes } = data;
    
    console.log('ğŸ”„ Handling status update:', status);
    
    // Update status display
    const statusEl = document.getElementById('bot-status');
    const statusLight = document.getElementById('status-light');
    const startForm = document.getElementById('start-form');
    const stopForm = document.getElementById('stop-form');
    
    // Hide starting indicator always
    const indicator = document.getElementById('bot-starting-indicator');
    if (indicator) indicator.style.display = 'none';
    
    if (status === 'running' || status === 'starting' || status === 'processing') {
      // Bot is active
      botIsRunning = true;
      
      let statusText = 'ğŸŸ¢ ÙØ¹Ø§Ù„ Ùˆ Ø¯Ø± Ø­Ø§Ù„ Ú©Ø§Ø±';
      let statusColor = '#31c48d';
      
      if (status === 'starting') {
        statusText = 'ğŸŸ¡ Ø¯Ø± Ø­Ø§Ù„ Ø´Ø±ÙˆØ¹...';
        statusColor = '#ffa500';
      }
      
      if (statusEl) {
        statusEl.innerHTML = statusText;
        statusEl.style.color = statusColor;
      }
      
      if (statusLight) {
        statusLight.className = 'status-light running';
        statusLight.style.background = statusColor;
      }
      
      if (startForm) startForm.style.display = 'none';
      if (stopForm) stopForm.style.display = 'block';
      
      // Enable stop button
      const stopBtn = document.getElementById('stop-btn');
      if (stopBtn) {
        stopBtn.disabled = false;
        stopBtn.textContent = 'â¹ï¸ ØªÙˆÙ‚Ù Ø±Ø¨Ø§Øª';
      }
      
    } else if (status === 'stopped' || status === 'idle') {
      // Bot is stopped
      botIsRunning = false;
      
      if (statusEl) {
        statusEl.innerHTML = 'ğŸ”´ ØºÛŒØ±ÙØ¹Ø§Ù„';
        statusEl.style.color = '#ff3b30';
      }
      
      if (statusLight) {
        statusLight.className = 'status-light inactive';
        statusLight.style.background = '#ccc';
      }
      
      if (startForm) startForm.style.display = 'block';
      if (stopForm) stopForm.style.display = 'none';
      
      // Enable start button
      const startBtn = document.getElementById('start-btn');
      if (startBtn) {
        startBtn.disabled = false;
        startBtn.textContent = 'â–¶ï¸ Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª';
      }
    }
    
    // Update likes count
    if (typeof likes !== 'undefined') {
      const likesEl = document.getElementById('bot-likes');
      if (likesEl) likesEl.textContent = likes;
    }
    
    // Update target
    if (target) {
      const targetRow = document.getElementById('current-target-row');
      const targetEl = document.getElementById('current-target');
      if (targetRow) targetRow.style.display = 'flex';
      if (targetEl) targetEl.textContent = `#${target}`;
    }
    
    // Update activity message
    if (message) {
      const activityEl = document.getElementById('bot-activity');
      if (activityEl) activityEl.textContent = message;
      
      // Add to activity log
      addToActivityLog(data);
    }
  }

  // ØªØ§Ø¨Ø¹ addToActivityLog Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯:
  function addToActivityLog(data) {
    const log = document.getElementById('activity-log');
    if (!log) return;
    
    const entry = document.createElement('div');
    let logClass = 'log-entry';
    
    if (data.status === 'error') logClass += ' log-error';
    else if (data.status === 'liked' || data.status === 'post_completed') logClass += ' log-success';
    else if (data.status === 'running') logClass += ' log-success';
    else logClass += ' log-info';
    
    entry.className = logClass;
    const time = new Date().toLocaleTimeString('fa-IR', {
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });

    let msgHtml = data.message || '';
    if (data.postLink) {
      msgHtml += ` <a href="${data.postLink}" target="_blank" class="post-link">ğŸ”— Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø³Øª</a>`;
    }

    entry.innerHTML = `<span class="log-time">${time}</span><span class="log-msg">${msgHtml}</span>`;
    log.insertBefore(entry, log.firstChild);

    // Keep only last 50 entries
    while (log.children.length > 50) {
      log.removeChild(log.lastChild);
    }
  }

  function showNotification(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      bottom: 2rem;
      right: 1rem;
      background: white;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 999;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
      notification.remove();
    }, 3000);
  }

  // Clear log button
  const clearLogBtn = document.getElementById('clear-log-btn');
  if (clearLogBtn) {
    clearLogBtn.addEventListener('click', () => {
      const log = document.getElementById('activity-log');
      if (log && confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ØªÙ…Ø§Ù… Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯ØŸ')) {
        log.innerHTML = '<div class="log-entry log-info"><span class="log-time">-</span><span class="log-msg">Ù„Ø§Ú¯ Ù¾Ø§Ú© Ø´Ø¯. Ù…Ù†ØªØ¸Ø± ÙØ¹Ø§Ù„ÛŒØª Ø¬Ø¯ÛŒØ¯...</span></div>';
      }
    });
  }

  if (document.querySelector('.status-area')) {
    initWebSocket();
  }
})();
</script>
